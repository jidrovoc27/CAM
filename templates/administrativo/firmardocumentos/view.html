{% extends 'baseapp.html' %}
{% load static %}
{% block head %}

{% endblock %}
{% block contenido %}

    <div class="card" style="padding: 15px">
        <div class="row">
            <div class="col-12">
                <div class="headtitle">
                    <h3 class="texto-blue"><i class="fa fa-signature"></i> {{ titulo }}</h3>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-4" id="formularioSubmit">
                <form class="form-horizontal form-modal well" autocomplete="off" method="post"
                      enctype="multipart/form-data" action="{{ request.path }}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <input type="hidden" name="action" value="firmardocumento">
                        <div id="fieldset_archivo" class="mb-3">
                            <label class="form-label" for="id_archivo"><b>Archivo<span
                                    style="color:red;margin-left:2px;"><strong>*</strong></span>&nbsp;:</b></label>
                            <input type="file" name="archivo" class="form-control" required id="id_archivo"
                                   accept=".pdf">
                            <p class="help-text">Tamaño máximo permitido 4Mb, en formato .pdf</p>
                        </div>
                        <div id="fieldset_firma" class="mb-3">
                            <label class="form-label" for="id_firma"><b>Firma Electrónica<span
                                    style="color:red;margin-left:2px;"><strong>*</strong></span>&nbsp;:</b></label>
                            <input type="file" name="firma" class="form-control" required id="id_firma"
                                   accept=".p12,.pfx">
                            <p class="help-text">Formato permitido .p12 y .pfx</p>
                        </div>
                        <div id="fieldset_pass" class="mb-3">
                            <label class="form-label" for="id_palabraclave"><b>Contraseña<span
                                    style="color:red;margin-left:2px;"><strong>*</strong></span>&nbsp;:</b></label>
                            <input type="password" name="palabraclave" class="form-control" required
                                   id="id_palabraclave" placeholder="Contraseña">
                        </div>
                        <input autocomplete="False" type='hidden' id="id_txtFirmas" name='txtFirmas' value=''/>
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-success" id="btnFirmar">
                                <i class="fa fa-signature"></i> Firmar
                            </button>
                            <br>
                            <a href="javascript:void(0)" class="texto_alerta"><b>Instrucciones:</b>
                                <br>Para eliminar firma doble click.
                                <br>Se puede aplicar más de 1 firma en el documento.
                            </a>
                        </div>
                    </div>
                </form>
            </div>
            <div class="col-8" id="cajaRender">

                <div class='row well caja-fixed' id="cajaAccion">
                    <div class="col-3">
                        <div class="input-group">
                            <button type="button" class="btn btn-info w-100" id="bntPegarFirma" style="font-size: 10px">
                                <i class="fa fa-stamp"></i> Colocar firma aquí
                            </button>
                        </div>
                    </div>
                    <div class="col-3">
                        <select id="current_page" class="form-select" style="text-align: center; width: 100%">
                            <option value=""></option>
                        </select>
                    </div>
                    <div class="col-6">
                        <span id="firmasInfo"></span>
                    </div>
                </div>
                <div class="text-center">
                    <div id="fileContainer" style="width: 100%;">
                        <div id="fileViewer" style="width: 100%;">
                            <canvas id="fileRendered"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="itemspanel" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title"><b class="paneltitle">FORMULARIO MODAL</b></h4>
                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal" id="formverificar" autocomplete="off" method="post"
                              enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <input type="hidden" name="action" value="verificarfirmas">
                                <div id="fieldset_firma" class="mb-3">
                                    <label class="form-label" for="id_archivo_verificar"><b>Documento firmado<span
                                            style="color:red;margin-left:2px;"><strong>*</strong></span>&nbsp;:</b></label>
                                    <input type="file" name="archivo_verificar" class="form-control" required
                                           id="id_archivo_verificar" accept=".pdf">
                                    <p class="help-text text-secondary">Formato permitido .pdf</p>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-bordered tabla_firmas" id="tabla_verify">
                                    <thead class="table-light">
                                    <tr>
                                        <th colspan="6" class="text-center">RESULTADOS DE LA VERIFICACIÓN DE ARCHIVO
                                            FIRMADO ELECTRÓNICAMENTE
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>Cédula</th>
                                        <th>Nombres</th>
                                        <th>Entidad Certificadora</th>
                                        <th>Fecha Firmado</th>
                                        <th>Firma</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">Seleccione su documento y verifique.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-end">
                                <button type="button" id="verificar" class="btn btn-success fs-5"><i
                                        class="fa fa-check"></i> Verificar
                                </button>
                                <a href="javascript:void(0)" class="btn btn-danger fs-5" data-bs-dismiss="modal"><i
                                        class="fa fa-close"></i> Cancelar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="itemcerrar" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <i class="fa fa-refresh fa-spin"></i> En caso de tener éxito cerrar la ventana.
                        <br>
                        <a href="javascript:void(0)" class="btn btn-danger fs-5" data-bs-dismiss="modal"><i
                                class="fa fa-close"></i> Cerrar</a>
                    </div>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block script %}
    <script src="{% static 'firmaec/pdf.js' %}"></script>
    <script src="{% static 'firmaec/pdf.worker.js' %}"></script>
    <script src="{% static 'firmaec/konva.min.js' %}"></script>
    {% include 'administrativo/firmardocumentos/script.html' %}
    <script>
        $('#formularioSubmit').submit(function (e) {
            Block_UI();
            var funcfirma = funcionAntesDeGuardarFirma();
            if (!funcfirma) {
                e.preventDefault();
                $.unblockUI();
                return false;
            } else {
                $('#itemcerrar').modal({"backdrop": "static"}).modal('show');
                $.unblockUI();
            }
        });
    </script>

{% endblock %}