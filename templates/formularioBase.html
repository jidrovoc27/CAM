{% extends 'baseapp.html' %}
{% load static %}
{% block head %}

{% endblock %}

{% block contenido %}
    {% block contenido_extra %}

    {% endblock %}

    <div class="mx-auto {% block class_extra_card_formulario %}{% endblock %} ">

        <div class="card ">
            <div class="card-body ">
                <h5 class="font-weight-bolder">{% block titulo %}{% endblock %}</h5>

                <div class="">
                    <form class="" method="POST" id="formulario_data_enviar" enctype="multipart/form-data">
                        {% block inputs_extras %}{% endblock %}
                        {% csrf_token %}

                        {% for field in form %}

                            <div class="input-group input-group-static my-3  ">
                                {{ field.errors }} {{ field.label_tag }} {{ field }} {% if field.help_text %}
                                <small id="help"
                                       class="form-text text-muted">{{ field.help_text|safe }}</small> {% endif %}
                            </div>

                        {% endfor %}
                        {% block news_inputs_form %}

                        {% endblock %}

                        <div class="d-flex justify-content-end ">
                            <a href="javascript:history.back()" name="button" class="btn btn-light m-0">Cancelar</a>
                            <button id="submit" type="submit" class="btn btn-success m-0 ms-2">
                                {% block nombre_boton_submit %}{% endblock %}</button>
                            {% block botones_extras %}
                            {% endblock %}
                        </div>
                    </form>
                </div>

            </div>

        </div>
        <br>

    </div>

{% endblock %}


{% block script %}

    <script>
        {#$(function () {#}
        {#    //Date picker#}
        {#    $('#id_fecha_cita').datetimepicker({#}
        {#        format: 'DD-MM-YYYY'#}
        {#    });#}
        {##}
        {# });#}


        $('#formulario_data_enviar').submit(function (e) {
            e.preventDefault(); // Evitar el comportamiento predeterminado del formulario

            var $form = $(this);

            // Verificar la validez del formulario utilizando el método 'valid()' del plugin jQuery Validation
            if ($form.valid()) {
                // Crear un objeto FormData para enviar los datos del formulario, incluidos los archivos adjuntos
                var forms = $('#formulario_data_enviar')[0];
                var formData = new FormData(forms);

                // Bloquear la interfaz mientras se envían los datos
                bloquearMovimiento();

                // Realizar la solicitud AJAX para enviar los datos del formulario
                $.ajax({
                    url: '{{ request.path }}',
                    type: 'POST',
                    dataType: 'json',
                    data: formData,
                    cache: false,
                    contentType: false, // Indicar a jQuery que no configure automáticamente el tipo de contenido de la solicitud
                    processData: false, // Indicar a jQuery que no procese los datos
                    success: function (data) {
                        // Manejar la respuesta exitosa del servidor
                        if (data.respuesta === true) {
                            $.unblockUI(); // Desbloquear la interfaz
                            // Mostrar un mensaje de éxito utilizando la biblioteca Swal (SweetAlert)
                            Swal.fire(
                                'Envio de datos',
                                data.mensaje,
                                'success'
                            ).then((result) => {
                                if (result.isConfirmed) {
                                    // Redirigir a una ubicación específica después del éxito
                                    location.href = "{% block location_href_destino %}
                                        /{% endblock %}" + ((data.id) ? data.id : "");
                                }
                            });
                        } else {
                            // Manejar la respuesta del servidor si no fue exitosa
                            $.unblockUI(); // Desbloquear la interfaz
                            Swal.fire(
                                'Advertencia!',
                                data.mensaje,
                                'warning'
                            );
                            if (data.repetidos) {
                                $.unblockUI();
                                if (data.repetidos.length > 0) {
                                    myToast.reset('all')
                                    repetidos = data.repetidos;
                                    $.toast({
                                        heading: data.mensaje,
                                        text: repetidos,
                                        showHideTransition: 'slide',
                                        icon: 'info',
                                        position: 'top-right',
                                        stack: false
                                    });
                                }
                            }
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // Manejar errores de la solicitud AJAX
                        $.unblockUI(); // Desbloquear la interfaz
                        var mensaje = '';
                        if (jqXHR.status === 0) {
                            mensaje = 'Not connect: Verify Network.';
                        } else if (jqXHR.status == 404) {
                            mensaje = 'Requested page not found [404]';
                        } else if (jqXHR.status == 500) {
                            mensaje = 'Internal Server Error [500].';
                        } else if (textStatus === 'parsererror') {
                            mensaje = 'Requested JSON parse failed.';
                        } else if (textStatus === 'timeout') {
                            mensaje = 'Time out error.';
                        } else if (textStatus === 'abort') {
                            mensaje = 'Ajax request aborted.';
                        } else {
                            mensaje = 'Uncaught Error: ' + jqXHR.responseText;
                        }
                        alert("Error al enviar los datos: " + mensaje);
                    },
                });
            } else {
                $.unblockUI();
                return false; // Devolver falso para evitar el envío del formulario si no es válido
            }
        });

    </script>

    <script type="text/javascript">
        $(document).ready(function () {
            $("select").select2({"width": "100%"});
        });
    </script>

    {% block js %}

    {% endblock %}

{% endblock %}